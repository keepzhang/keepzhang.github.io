
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>mysql双主复制及keepalived高可用 | 极客运维</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="Keep zhang">
    
    <meta name="description" itemprop="description" content="实现基本的数据备份及高可用配置">
    
    
    
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/pacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/pacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      <div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="极客运维" title="极客运维"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="极客运维">极客运维</a></h1>
				<h2 class="blog-motto">不懂产品的运维不是好架构师</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					
						<li><a href="/">主页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
					<li>
					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:keepzhang.github.io">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/13/mysql双主复制及keepalived高可用/" title="mysql双主复制及keepalived高可用" itemprop="url">mysql双主复制及keepalived高可用</a>
  </h1>
  <p class="article-author">By
    
      <a href="http://keepzhang.github.io" title="Keep zhang">Keep zhang</a>
    </p>
  <p class="article-time">
    <time datetime="2016-04-13T00:44:37.000Z" itemprop="datePublished">2016-04-13</time>
    更新日期:<time datetime="2016-05-31T02:26:55.000Z" itemprop="dateModified">2016-05-31</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">文章目录</strong>
		<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#实验环境介绍"><span class="toc-number">1.</span> <span class="toc-text">实验环境介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql-yum安装"><span class="toc-number">1.1.</span> <span class="toc-text">mysql yum安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Adding-the-MySQL-Yum-Repository"><span class="toc-number">1.1.1.</span> <span class="toc-text">Adding the MySQL Yum Repository</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Selecting-a-Release-Series"><span class="toc-number">1.1.2.</span> <span class="toc-text">Selecting a Release Series</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Installing-MySQL"><span class="toc-number">1.1.3.</span> <span class="toc-text">Installing MySQL</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql双主复制"><span class="toc-number">1.2.</span> <span class="toc-text">mysql双主复制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建同步用户"><span class="toc-number">1.2.1.</span> <span class="toc-text">创建同步用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改-etc-my-cnf-配置文件-为其添加以下内容"><span class="toc-number">1.2.2.</span> <span class="toc-text">修改 /etc/my.cnf 配置文件,为其添加以下内容:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分别重启服务器node1、node2上的mysql服务"><span class="toc-number">1.2.3.</span> <span class="toc-text">分别重启服务器node1、node2上的mysql服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分别在服务器node1、node2上查看做为主服务器状态"><span class="toc-number">1.2.4.</span> <span class="toc-text">分别在服务器node1、node2上查看做为主服务器状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分别在服务器node1、node2上用change-master语句指定同步位置"><span class="toc-number">1.2.5.</span> <span class="toc-text">分别在服务器node1、node2上用change master语句指定同步位置 :</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分别在服务器node1、node2上启动从服务器线程"><span class="toc-number">1.2.6.</span> <span class="toc-text">分别在服务器node1、node2上启动从服务器线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看auto-cnf文件"><span class="toc-number">1.2.7.</span> <span class="toc-text">查看auto.cnf文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#再次查看l两节点slave的状态已经正常"><span class="toc-number">1.2.8.</span> <span class="toc-text">再次查看l两节点slave的状态已经正常</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试"><span class="toc-number">1.2.9.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#keepalived高可用"><span class="toc-number">1.3.</span> <span class="toc-text">keepalived高可用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#通过yum安装keepalived"><span class="toc-number">1.3.1.</span> <span class="toc-text">通过yum安装keepalived</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改配置文件"><span class="toc-number">1.3.2.</span> <span class="toc-text">修改配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试高可用性"><span class="toc-number">1.3.3.</span> <span class="toc-text">测试高可用性</span></a></li></ol></li></ol></li></ol>
		</div>
		
		<h1 id="实验环境介绍"><a href="#实验环境介绍" class="headerlink" title="实验环境介绍"></a>实验环境介绍</h1><p><img src="http://7ktu2o.com1.z0.glb.clouddn.com/%E8%87%B4%E8%87%AA%E5%B7%B1.jpg" alt="致青春"></p>
<table>
<thead>
<tr>
<th>服务器名</th>
<th style="text-align:right">IP地址</th>
<th style="text-align:center">系统</th>
<th>Mysql</th>
<th>keepalived</th>
</tr>
</thead>
<tbody>
<tr>
<td>node1</td>
<td style="text-align:right">192.168.2.172</td>
<td style="text-align:center">rhel-6.7</td>
<td>5.7.11</td>
<td>1.2.13</td>
</tr>
<tr>
<td>node2</td>
<td style="text-align:right">192.168.2.173</td>
<td style="text-align:center">rhel-6.7</td>
<td>5.7.11</td>
<td>1.2.13</td>
</tr>
<tr>
<td>VIP</td>
<td style="text-align:right">192.168.2.254</td>
<td style="text-align:center"></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="mysql-yum安装"><a href="#mysql-yum安装" class="headerlink" title="mysql yum安装"></a>mysql yum安装</h2><p>mysql下载链接<a href="http://dev.mysql.com/downloads/mysql/" target="_blank" rel="external">http://dev.mysql.com/downloads/mysql/</a></p>
<p>Download MySQL Yum Repository<a href="http://dev.mysql.com/downloads/repo/yum/" target="_blank" rel="external">http://dev.mysql.com/downloads/repo/yum/</a></p>
<p><img src="http://7xs8rn.com1.z0.glb.clouddn.com/mysql%20yum%20repository.png" alt=""></p>
<p><img src="http://7xs8rn.com1.z0.glb.clouddn.com/mysql-yum%20quick%20guide.png" alt=""></p>
<p>A Quick Guide to Using the MySQL Yum Repository<a href="http://dev.mysql.com/doc/mysql-yum-repo-quick-guide/en/" target="_blank" rel="external">http://dev.mysql.com/doc/mysql-yum-repo-quick-guide/en/</a></p>
<h3 id="Adding-the-MySQL-Yum-Repository"><a href="#Adding-the-MySQL-Yum-Repository" class="headerlink" title="Adding the MySQL Yum Repository"></a>Adding the MySQL Yum Repository</h3><blockquote>
<p>a. Go to the download page for MySQL Yum repository at <a href="http://dev.mysql.com/downloads/repo/yum/" target="_blank" rel="external">http://dev.mysql.com/downloads/repo/yum/</a>.<br>b. Select and download the release package for your platform.<br>c. Install the downloaded release package with the following command, replacing platform-and-version-specific-package-name with the name of the downloaded package:<br>shell&gt; sudo rpm -Uvh platform-and-version-specific-package-name.rpm<br>For example, for version n of the package for EL6-based systems, the command is:<br>shell&gt; sudo rpm -Uvh mysql57-community-release-el6-n.noarch.rpm</p>
</blockquote>
<h3 id="Selecting-a-Release-Series"><a href="#Selecting-a-Release-Series" class="headerlink" title="Selecting a Release Series"></a>Selecting a Release Series</h3><blockquote>
<p>When using the MySQL Yum repository, the latest GA release of MySQL is selected for installation by default. If this is what you want, you can skip to the next step,Installing MySQL with Yum.<br>Within the MySQL Yum repository (<a href="http://repo.mysql.com/yum/" target="_blank" rel="external">http://repo.mysql.com/yum/</a>), different release series of the MySQL Community Server are hosted in different subrepositories. The subrepository for the latest GA series (currently MySQL 5.7) is enabled by default, and the subrepositories for all other series (for example, the MySQL 5.6 series) are disabled by default. Use this command to see all the subrepositories in the MySQL Yum repository, and see which of them are enabled or disabled (for dnf-enabled systems, replace yum in the command with dnf):<br>shell&gt; yum repolist all | grep mysql<br>To install the latest release from the latest GA series, no configuration is needed. To install the latest release from a specific series other than the latest GA series, disable the subrepository for the latest GA series and enable the subrepository for the specific series before running the installation command. You can do that by editing manually the /etc/yum.repos.d/mysql-community.repo file. This is a typical entry for a release series’ subrepository in the file:<br>[mysql57-community]<br>name=MySQL 5.7 Community Server<br>baseurl=<a href="http://repo.mysql.com/yum/mysql-5.7-community/el/6/$basearch/" target="_blank" rel="external">http://repo.mysql.com/yum/mysql-5.7-community/el/6/$basearch/</a><br>enabled=1<br>gpgcheck=1<br>gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-mysql<br>Find the entry for the subrepository you want to configure, and edit the enabled option. Specify enabled=0 to disable a subrepository, or enabled=1 to enable a subrepository. For example, to install MySQl 5.6, make sure you have enabled=0 for the above subrepository entry for MySQL 5.7, and have enabled=1 for the entry for the 5.6 series:<br>Enable to use MySQL 5.6<br>[mysql56-community]<br>name=MySQL 5.6 Community Server<br>baseurl=<a href="http://repo.mysql.com/yum/mysql-5.6-community/el/6/$basearch/" target="_blank" rel="external">http://repo.mysql.com/yum/mysql-5.6-community/el/6/$basearch/</a><br>enabled=1<br>gpgcheck=1<br>gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-mysql<br>You should only enable subrepository for one release series at any time. When subrepositories for more than one release series are enabled, the latest series will be used by Yum.<br>Verify that the correct subrepositories have been enabled and disabled by running the following command and checking its output (for dnf-enabled systems, replaceyum in the command with dnf):<br>shell&gt; yum repolist enabled | grep mysql</p>
</blockquote>
<h3 id="Installing-MySQL"><a href="#Installing-MySQL" class="headerlink" title="Installing MySQL"></a>Installing MySQL</h3><blockquote>
<p>Install MySQL by the following command (for dnf-enabled systems, replace yum in the command with dnf):<br>shell&gt; sudo yum install mysql-community-server<br>This installs the package for the MySQL server, as well as other required packages.<br>Starting the MySQL Server<br>Start the MySQL server with the following command:<br>shell&gt; sudo service mysqld start<br>You can check the status of the MySQL server with the following command:<br>shell&gt; sudo service mysqld status<br>For MySQL 5.7 only: At the initial start up of the server, the following happens, given that the data directory of the server is empty:<br>The server is initialized.<br>An SSL certificate and key files are generated in the data directory.<br>The validate_password plugin is installed and enabled.<br>A superuser account ‘root’@’localhost’ is created. A password for the superuser is set and stored in the error log file. To reveal it, use the following command:<br>shell&gt; sudo grep ‘temporary password’ /var/log/mysqld.log<br>Change the root password as soon as possible by logging in with the generated, temporary password and set a custom password for the superuser account:<br>shell&gt; mysql -uroot -p<br>mysql&gt; ALTER USER ‘root’@’localhost’ IDENTIFIED BY ‘MyNewPass4!’;</p>
</blockquote>
<h2 id="mysql双主复制"><a href="#mysql双主复制" class="headerlink" title="mysql双主复制"></a>mysql双主复制</h2><p>假设要同步的库是test</p>
<h3 id="创建同步用户"><a href="#创建同步用户" class="headerlink" title="创建同步用户"></a>创建同步用户</h3><p>在node1上<br>mysql&gt; grant replication slave on <em>.</em> to ‘sync’@’192.168.2.173’ identified by ‘ShenZhou_CJ3;<br>Query OK, 0 rows affected (0.00 sec)<br>mysql&gt; flush privileges;<br>Query OK, 0 rows affected (0.00 sec)<br>在node2 上<br>mysql&gt; grant replication slave on <em>.</em> to ‘sync’@’192.168.2.172’ identified by ‘ShenZhou_CJ3’;<br>Query OK, 0 rows affected (0.11 sec)<br>mysql&gt; flush privileges;<br>Query OK, 0 rows affected (0.00 sec)</p>
<h3 id="修改-etc-my-cnf-配置文件-为其添加以下内容"><a href="#修改-etc-my-cnf-配置文件-为其添加以下内容" class="headerlink" title="修改 /etc/my.cnf 配置文件,为其添加以下内容:"></a>修改 /etc/my.cnf 配置文件,为其添加以下内容:</h3><p>在 node1上<br>[mysqld]<br>server-id=1  #数据同步时用于标识该语句最初是从哪个server写入的，进行主主或主备搭建时，都需填写<br>log-bin=mysql-bin<br>binlog-do-db=db_rocky #需要记录进制日志的数据库.如果有多个数据库可用逗号分隔,或者使用多个binlog-do-db选项<br>binlog-ignore-db=mysql #不需要记录进制日志的数据库.如果有多个数据库可用逗号分隔,或者使用多个binlog-do-db选项<br>replicate-do-db=db_rocky #需要进行同步的数据库.如果有多个数据库可用逗号分隔,或者使用多个replicate-do-db选项<br>replicate-ignore-db=mysql,information_schema #不需要同步的数据库.如果有多个数据库可用逗号分隔,或者使用多个replicate-ignore-db选项<br>同步参数:<br>保证slave挂在任何一台master上都会接收到另一个master的写入信息<br>log-slave-updates<br>sync_binlog=1<br>auto_increment_offset=1<br>auto_increment_increment=2<br>slave-skip-errors=all #过滤掉一些没啥大问题的错误<br>在 node2上<br>[mysqld]<br>server-id=2 #设置一个不同的id、注意这里在my.cnf里面有个默认值是 1 、把默认值改掉、而不能新增一个server-id<br>log-bin=mysql-bin<br>binlog-do-db=db_rocky #需要记录二进制日志的数据库.如果有多个数据库可用逗号分隔,或者使用多个binlog-do-db选项<br>binlog-ignore-db=mysql #不需要记录进制日志的数据库.如果有多个数据库可用逗号分隔,或者使用多个binlog-ignore-db选项<br>需要同步的数据库<br>replicate-do-db=db_rocky #需要进行同步的数据库.如果有多个数据库可用逗号分隔,或者使用多个binlog-do-db选项<br>replicate-ignore-db=mysql,information_schema #不需要同步的数据库.如果有多个数据库可用逗号分隔,或者使用多个binlog-do-db选项</p>
<p>**同步参数:</p>
<p>**保证slave挂在任何一台master上都会接收到另一个master的写入信息<br>log-slave-updates<br>sync_binlog=1<br>auto_increment_offset=2<br>auto_increment_increment=2<br>slave-skip-errors=all #过滤掉一些没啥大问题的错误</p>
<h3 id="分别重启服务器node1、node2上的mysql服务"><a href="#分别重启服务器node1、node2上的mysql服务" class="headerlink" title="分别重启服务器node1、node2上的mysql服务"></a>分别重启服务器node1、node2上的mysql服务</h3><h3 id="分别在服务器node1、node2上查看做为主服务器状态"><a href="#分别在服务器node1、node2上查看做为主服务器状态" class="headerlink" title="分别在服务器node1、node2上查看做为主服务器状态"></a>分别在服务器node1、node2上查看做为主服务器状态</h3><p>在node1<br>mysql&gt; flush tables with read lock;#防止进入新的数据<br>Query OK, 0 rows affected (0.00 sec)<br>mysql&gt; show master status\G     #不带分号，否则报错ERROR: No query specified<br><strong><strong><strong><strong><strong><strong>*</strong></strong></strong></strong></strong></strong> 1. row <strong><strong><strong><strong><strong><strong><em>*</em></strong></strong></strong></strong></strong></strong><br>                   File: mysql-bin.000006<br>         Position: 1050<br>     Binlog_Do_DB: test<br> Binlog_Ignore_DB: mysql,information_schema,performance_schema,sys<br>Executed_Gtid_Set:<br>1 row in set (0.00 sec)<br>在node2<br>mysql&gt; flush tables with read lock;<br>Query OK, 0 rows affected (0.00 sec)<br>mysql&gt; show master status\G    #不带分号，否则报错ERROR: No query specified<br><strong><strong><strong><strong><strong><strong><em>*</em></strong></strong></strong></strong></strong></strong> 1. row <strong><strong><strong><strong><strong><strong><em>*</em></strong></strong></strong></strong></strong></strong><br>           File: mysql-bin.000003<br>         Position: 1068<br>     Binlog_Do_DB: test<br> Binlog_Ignore_DB: mysql,information_schema,performance_schema,sys<br>Executed_Gtid_Set:<br>1 row in set (0.01 sec)</p>
<h3 id="分别在服务器node1、node2上用change-master语句指定同步位置"><a href="#分别在服务器node1、node2上用change-master语句指定同步位置" class="headerlink" title="分别在服务器node1、node2上用change master语句指定同步位置 :"></a>分别在服务器node1、node2上用change master语句指定同步位置 :</h3><p>在node1<br>如果已经start slave,需要执行stop slave;,并且unlock tables;<br>否则会出现如下错误：<br>ERROR 3021 (HY000): This operation cannot be performed with a running slave io thread; run STOP SLAVE IO_THREAD FOR CHANNEL ‘’ first.<br>ERROR 1192 (HY000): Can’t execute the given command because you have active locked tables or an active transaction</p>
<p>mysql&gt; change master to master_host=’192.168.2.173’,master_user=’sync’,master_password=’ShenZhen_CJ3’,<br>    -&gt; master_log_file=’mysql-bin.000003’,master_log_pos=1068;   #对接点的信息<br>Query OK, 0 rows affected (0.05 sec)<br>在node2<br>如果已经start slave,需要执行stop slave;,并且unlock tables;<br>mysql&gt; change master to master_host=’192.168.2.172’,master_user=’sync’,master_password=’ShenZhou_CJ3’,<br>    -&gt; master_log_file=’mysql-bin.000006,master_log_pos=1050;<br>Query OK, 0 rows affected (0.15 sec)<br>注：master_log_file，master_log_pos由上面主服务器查出的状态值中确定<br>master_log_file对应File，master_log_pos对应Position<br>在node1、node2上<br>mysql&gt; unlock tables;<br>Query OK, 0 rows affected (0.00 sec)</p>
<h3 id="分别在服务器node1、node2上启动从服务器线程"><a href="#分别在服务器node1、node2上启动从服务器线程" class="headerlink" title="分别在服务器node1、node2上启动从服务器线程"></a>分别在服务器node1、node2上启动从服务器线程</h3><p>mysql&gt; start slave;<br>Query OK, 0 rows affected (0.00 sec)<br>分别在服务器node1、node2上查看从服务器状态 :<br>node1上<br>mysql&gt; show slave status\G<br><strong><strong><strong><strong><strong><strong><em>*</em></strong></strong></strong></strong></strong></strong> 1. row <strong><strong><strong><strong><strong><strong><em>*</em></strong></strong></strong></strong></strong></strong><br>主要关注以下 2 个参数：<br>…<br>…<br>            Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br>…<br>…</p>
<p>node2上：<br>mysql&gt; show slave status\G<br><strong><strong><strong><strong><strong><strong><em>*</em></strong></strong></strong></strong></strong></strong> 1. row <strong><strong><strong><strong><strong><strong><em>*</em></strong></strong></strong></strong></strong></strong><br>主要关注以下 2 个参数：<br>…<br>…<br>            Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br>…</p>
<blockquote>
<p>在测试中出现Slave_IO_Running: No Slave_SQL_Running: Yes  Seconds_Behind_Master: NULL情况</p>
<p>排查过程为：查看mysql日志文件 tail -f /var/log/mysqld.log</p>
<p>发现报错信息[ERROR] Slave I/O for channel ‘’: Fatal error: The slave I/O thread stops because master and slave have equal MySQL server UUIDs; these UUIDs must be different for replication to work. Error_code: 1593</p>
<p>1、错误消息<br>mysql&gt; show slave staus;<br>Last_IO_Error: Fatal error: The slave I/O thread stops because master and slave have equal MySQL server UUIDs;<br>these UUIDs must be different for replication to work.<br>2、查看主从的server_id变量<br>node1&gt; show variables like ‘server_id’;<br>+—————+——-+<br>| Variable_name | Value |<br>+—————+——-+<br>| server_id    | 1|<br>+—————+——-+<br>node2&gt; show variables like ‘server_id’;<br>+—————+——-+<br>| Variable_name | Value |<br>+—————+——-+<br>| server_id    |2    |<br>+—————+——-+<br>– 从上面的情形可知，主从mysql已经使用了不同的server_id<br>3、解决故障</p>
<h3 id="查看auto-cnf文件"><a href="#查看auto-cnf文件" class="headerlink" title="查看auto.cnf文件"></a>查看auto.cnf文件</h3><p>[root@node1~]#more /usr/local/mysql/auto.cnf  ### 主上的uuid<br>[auto]<br>server-uuid=615fecec-fe27-11e5-b7ec-000c29d5bb93<br>[root@node2~]#more /usr/local/mysql/auto.cnf  ###从上的uuid，果然出现了重复，原因是克隆了虚拟机，只改server_id不行<br>[auto]<br>server-uuid=615fecec-fe27-11e5-b7ec-000c29d5bb93<br>[root@node2~]# mv /usr/local/mysql/auto.cnf  /usr/local/mysql/auto.cnf.bk  ###重命名该文件<br>[root@node2~]# service mysql restart          ###重启mysql<br>Shutting down MySQL.[  OK  ]<br>Starting MySQL.[  OK  ]<br>[root@node2~]#more /usr/local/mysql/auto.cnf  ###重启后自动生成新的auto.cnf文件，即新的UUID<br>[auto]<br>server-uuid=37ea8741-00bd-11e6-bcdb-000c294d8f22<br>[root@node1~]# service mysql restart          ###重启mysql<br>Shutting down MySQL.[  OK  ]<br>Starting MySQL.[  OK  ]</p>
<h3 id="再次查看l两节点slave的状态已经正常"><a href="#再次查看l两节点slave的状态已经正常" class="headerlink" title="再次查看l两节点slave的状态已经正常"></a>再次查看l两节点slave的状态已经正常</h3><p>[root@noss2~]#<br>            Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br>            Seconds_Behind_Master: 0<br>[root@noss1~]#<br>            Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br>            Seconds_Behind_Master: 0</p>
</blockquote>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>node2上<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| sys                |</span><br><span class="line">| test               |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line">mysql&gt; use test;</span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; show tables;</span><br><span class="line">+----------------+</span><br><span class="line">| Tables_in_test |</span><br><span class="line">+----------------+</span><br><span class="line">| test1          |</span><br><span class="line">+----------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">mysql&gt; create table sync (id int);</span><br><span class="line">Query OK, 0 rows affected (0.23 sec)</span><br><span class="line">mysql&gt;insert into sync values(1);</span><br><span class="line">Query OK, 1 row affected (0.09 sec)</span><br><span class="line">mysql&gt; commit;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure></p>
<p>在 node1上<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show tables;</span><br><span class="line">+----------------+</span><br><span class="line">| Tables_in_test |</span><br><span class="line">+----------------+</span><br><span class="line">| sync           |</span><br><span class="line">+----------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line">mysql&gt; select * from sync;</span><br><span class="line">+------+</span><br><span class="line">| id  |</span><br><span class="line">+------+</span><br><span class="line">|    1 |</span><br><span class="line">+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h2 id="keepalived高可用"><a href="#keepalived高可用" class="headerlink" title="keepalived高可用"></a>keepalived高可用</h2><h3 id="通过yum安装keepalived"><a href="#通过yum安装keepalived" class="headerlink" title="通过yum安装keepalived"></a>通过yum安装keepalived</h3><p>在node1、node2上分别安装keepalived<br>[root@node1 ~]# yum install keepalived<br>[root@node2 ~]# yum install keepalived</p>
<h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p>node1上<br>[root@node1 ~]# vim /etc/keepalived/keepalived.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line">################第一部分##################</span><br><span class="line">global_defs &#123;</span><br><span class="line"></span><br><span class="line">   router_id node1 #修改成自己的主机名</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">################第二部分##################</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP  #主备都为BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 60  #默认为51</span><br><span class="line">    priority 100  #备用节点必须比主节点优先级低</span><br><span class="line">    advert_int 1</span><br><span class="line">    nopreempt	#不抢占资源，主机状态恢复了也不会把主抢回</span><br><span class="line">    authentication &#123;</span><br><span class="line">	#验证信息，两节点必须一致</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.2.254</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">#################第三部分#####################</span><br><span class="line">virtual_server 192.168.2.254 3306 &#123;</span><br><span class="line">    delay_loop 6</span><br><span class="line">    lb_algo wrr  #LVS算法</span><br><span class="line">    lb_kind DR   #LVS模式</span><br><span class="line">    nat_mask 255.255.255.0</span><br><span class="line">    persistence_timeout 50 #会话保持时间</span><br><span class="line">    protocol TCP</span><br><span class="line">    real_server 192.168.2.172 3306 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        notify_down /usr/local/bin/mysql.sh #检测到服务down后执行的脚本</span><br><span class="line">	TCP_CHECK &#123;</span><br><span class="line">        connect_timeout 10	#连接超时时间</span><br><span class="line">        nb_get_retry 3		#重连次数</span><br><span class="line">#        delay_before_retry 3</span><br><span class="line">	connect_port 3306   	#健康检查端口</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>node2上<br>[root@node2 ~]# vim /etc/keepalived/keepalived.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line">#############第一部分################</span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id node2</span><br><span class="line">&#125;</span><br><span class="line">#############第二部分################</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP	#主备都为BACKUP</span><br><span class="line">    interface eth1</span><br><span class="line">    virtual_router_id 60	#默认为51</span><br><span class="line">    priority 90		#主节点优先级比备节点高</span><br><span class="line">    advert_int 1</span><br><span class="line">#    nopreempt</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">   virtual_ipaddress &#123;</span><br><span class="line">        192.168.2.254</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">###############第三部分#################</span><br><span class="line">virtual_server 192.168.2.254 3306 &#123;</span><br><span class="line">    delay_loop 6</span><br><span class="line">    lb_algo wrr</span><br><span class="line">    lb_kind DR</span><br><span class="line">    nat_mask 255.255.255.0</span><br><span class="line">    persistence_timeout 50</span><br><span class="line">    protocol TCP</span><br><span class="line">    real_server 192.168.2.173 3306 &#123;</span><br><span class="line">        weight 1</span><br><span class="line">        notify_down /usr/local/bin/mysql.sh	#对数据库状态进行判断</span><br><span class="line">	TCP_CHECK &#123;</span><br><span class="line">        connect_timeout 10</span><br><span class="line">        nb_get_retry 3</span><br><span class="line">#         delay_before_retry 3</span><br><span class="line">        connect_port 3306</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在node1、node2上创建/usr/local/bin/mysql.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">/etc/init.d/keepalived restart</span><br></pre></td></tr></table></figure></p>
<p>授权两台Mysql服务器允许root远程登录，用于在其他服务器登陆测试！<br>mysql&gt; grant all on <em>.</em> to’root’@’192.168.%.%’ identified by ‘ShenZhou_CJ3’;<br>mysql&gt; flush privileges;</p>
<h3 id="测试高可用性"><a href="#测试高可用性" class="headerlink" title="测试高可用性"></a>测试高可用性</h3><p>1、通过Mysql客户端通过VIP连接，看是否连接成功。<br>2、停止master这台mysql服务，是否能正常切换过去，可通过ip addr命令来查看VIP在哪台服务器上。<br>3、通过tcpdump vrrp命令抓取基于网络端口的vrrp协议包情况<br>4、可通过查看/var/log/messges日志，看出主备切换过程</p>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/keepalived/">keepalived</a><a href="/tags/mysql-Replication/">mysql_Replication</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/HA/">HA</a>
</div>



<div class="article-share" id="share">

  <div data-url="http://keepzhang.github.io/2016/04/13/mysql双主复制及keepalived高可用/" data-title="mysql双主复制及keepalived高可用 | 极客运维" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2016/05/18/nginx/" title="nginx">
  <strong>PREVIOUS:</strong><br/>
  <span>
  nginx</span>
</a>
</div>


<div class="next">
<a href="/2016/03/31/python入门基础/"  title="python入门基础">
 <strong>NEXT:</strong><br/> 
 <span>python入门基础
</span>
</a>
</div>

</nav>

	
<section class="comment">
	<div class="ds-thread"></div>
</section>

</div>  
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">文章目录</strong>
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#实验环境介绍"><span class="toc-number">1.</span> <span class="toc-text">实验环境介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql-yum安装"><span class="toc-number">1.1.</span> <span class="toc-text">mysql yum安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Adding-the-MySQL-Yum-Repository"><span class="toc-number">1.1.1.</span> <span class="toc-text">Adding the MySQL Yum Repository</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Selecting-a-Release-Series"><span class="toc-number">1.1.2.</span> <span class="toc-text">Selecting a Release Series</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Installing-MySQL"><span class="toc-number">1.1.3.</span> <span class="toc-text">Installing MySQL</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql双主复制"><span class="toc-number">1.2.</span> <span class="toc-text">mysql双主复制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建同步用户"><span class="toc-number">1.2.1.</span> <span class="toc-text">创建同步用户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改-etc-my-cnf-配置文件-为其添加以下内容"><span class="toc-number">1.2.2.</span> <span class="toc-text">修改 /etc/my.cnf 配置文件,为其添加以下内容:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分别重启服务器node1、node2上的mysql服务"><span class="toc-number">1.2.3.</span> <span class="toc-text">分别重启服务器node1、node2上的mysql服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分别在服务器node1、node2上查看做为主服务器状态"><span class="toc-number">1.2.4.</span> <span class="toc-text">分别在服务器node1、node2上查看做为主服务器状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分别在服务器node1、node2上用change-master语句指定同步位置"><span class="toc-number">1.2.5.</span> <span class="toc-text">分别在服务器node1、node2上用change master语句指定同步位置 :</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分别在服务器node1、node2上启动从服务器线程"><span class="toc-number">1.2.6.</span> <span class="toc-text">分别在服务器node1、node2上启动从服务器线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看auto-cnf文件"><span class="toc-number">1.2.7.</span> <span class="toc-text">查看auto.cnf文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#再次查看l两节点slave的状态已经正常"><span class="toc-number">1.2.8.</span> <span class="toc-text">再次查看l两节点slave的状态已经正常</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试"><span class="toc-number">1.2.9.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#keepalived高可用"><span class="toc-number">1.3.</span> <span class="toc-text">keepalived高可用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#通过yum安装keepalived"><span class="toc-number">1.3.1.</span> <span class="toc-text">通过yum安装keepalived</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改配置文件"><span class="toc-number">1.3.2.</span> <span class="toc-text">修改配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试高可用性"><span class="toc-number">1.3.3.</span> <span class="toc-text">测试高可用性</span></a></li></ol></li></ol></li></ol>
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
			<li><a href="/categories/HA/" title="HA">HA<sup>2</sup></a></li>
		
			<li><a href="/categories/Middleware/" title="Middleware">Middleware<sup>1</sup></a></li>
		
			<li><a href="/categories/programming-language/" title="programming language">programming language<sup>2</sup></a></li>
		
			<li><a href="/categories/吐槽/" title="吐槽">吐槽<sup>1</sup></a></li>
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			<li><a href="/tags/LVS/" title="LVS">LVS<sup>1</sup></a></li>
		
			<li><a href="/tags/Python/" title="Python">Python<sup>2</sup></a></li>
		
			<li><a href="/tags/keepalived/" title="keepalived">keepalived<sup>2</sup></a></li>
		
			<li><a href="/tags/mysql-Replication/" title="mysql_Replication">mysql_Replication<sup>1</sup></a></li>
		
			<li><a href="/tags/nginx/" title="nginx">nginx<sup>2</sup></a></li>
		
			<li><a href="/tags/生活/" title="生活">生活<sup>1</sup></a></li>
		
		</ul>
</div>


  <div class="rsspart">
	<a href="null" target="_blank" title="rss">RSS 订阅</a>
</div>

</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hi,i&#39;m keepzhang,this&#39;s my blog. <br/>
			welcome  you to access my geek home!!!</p>
	</section>
	 
	<div class="social-font clearfix">
		
		
		
		<a href="https://github.com/keepzhang" target="_blank" title="github"></a>
		
		
		
	</div>
		<p class="copyright">Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/A-limon/pacman" target="_blank" title="Pacman">Pacman</a> © 2016 
		
		<a href="http://keepzhang.github.io" target="_blank" title="Keep zhang">Keep zhang</a>
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{
    c.click(function(){
      ta.css('display', 'block').addClass('fadeIn');
    });
    o.click(function(){
      ta.css('display', 'none');
    });
    $(window).scroll(function(){
      ta.css("top",Math.max(140,320-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"keepzhang"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



  </body>
</html>
